name: Build Loop IPA
run-name: Build Loop IPA (${{ github.ref_name }})

on:
  workflow_dispatch: # manual run

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Select Xcode version
        run: sudo xcode-select --switch /Applications/Xcode_16.4.app/Contents/Developer

      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: bundle install

      - name: Sync clock (workaround for signing issues)
        run: sudo sntp -sS time.windows.com

      - name: Build IPA (unsigned)
        run: bundle exec fastlane build_loop
        env:
          # remove TestFlight keys, just need signing identity/profiles handled by Xcode
          TEAMID: ${{ secrets.TEAMID }}

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: loop-ipa
          path: artifacts/*.ipa
